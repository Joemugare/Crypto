{% extends 'base.html' %}
{% load static format_filters %}

{% block title %}Crypto Tracker - Home{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Action Buttons -->
    <div class="mb-4 d-flex gap-2">
        {% if not user.is_authenticated %}
            <a href="{% url 'login' %}" class="btn btn-primary animate-button" data-bs-toggle="tooltip" title="Log in to manage your portfolio">
                <i class="fas fa-sign-in-alt"></i> Login
            </a>
            <a href="{% url 'register' %}" class="btn btn-secondary animate-button" data-bs-toggle="tooltip" title="Create an account to get started">
                <i class="fas fa-user-plus"></i> Register
            </a>
        {% else %}
            <button class="btn btn-success animate-button" data-bs-toggle="modal" data-bs-target="#addPortfolioModal" title="Add a cryptocurrency to your portfolio">
                <i class="fas fa-plus"></i> Add Portfolio
            </button>
            <a href="{% url 'add_to_watchlist' %}" class="btn btn-info animate-button" data-bs-toggle="tooltip" title="Add a cryptocurrency to your watchlist">
                <i class="fas fa-eye"></i> Add to Watchlist
            </a>
            <a href="{% url 'add_alert' %}" class="btn btn-warning animate-button" data-bs-toggle="tooltip" title="Set a price alert for a cryptocurrency">
                <i class="fas fa-bell"></i> Set Alert
            </a>
        {% endif %}
    </div>

    <!-- Add Portfolio Modal -->
    {% if user.is_authenticated %}
    <div class="modal fade" id="addPortfolioModal" tabindex="-1" aria-labelledby="addPortfolioModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPortfolioModalLabel">Add to Portfolio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" action="{% url 'add_to_portfolio' %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="cryptocurrency" class="form-label">Cryptocurrency</label>
                            <select class="form-select" name="cryptocurrency" id="cryptocurrency" required>
                                <option value="" disabled selected>Select a cryptocurrency</option>
                                {% for coin_id, data in market_data.items %}
                                    <option value="{{ coin_id }}">{{ coin_id|capitalize_value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="amount" class="form-label">Amount</label>
                            <input type="number" class="form-control" name="amount" id="amount" step="0.00000001" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="purchase_price" class="form-label">Purchase Price (USD)</label>
                            <input type="number" class="form-control" name="purchase_price" id="purchase_price" step="0.01" min="0" required>
                        </div>
                        <button type="submit" class="btn btn-success">Add to Portfolio</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Pie Chart -->
    <h2>Market Price Distribution</h2>
    {% if is_data_live %}
        <div class="mb-4 glow-effect chart-container">
            <canvas id="pricePieChart" style="max-height: 300px;"></canvas>
        </div>
    {% else %}
        <div class="alert alert-warning glow-effect" role="alert">
            Unable to fetch market data for the chart. Please try again later.
        </div>
    {% endif %}

    <!-- Live Markets Table -->
    <h2>Live Markets</h2>
    {% if is_data_live %}
        <div class="mb-3">
            <select id="sortSelect" class="form-select w-auto d-inline-block">
                <option value="name">Sort by Name</option>
                <option value="price">Sort by Price</option>
                <option value="change">Sort by 24h Change</option>
                <option value="volume">Sort by Volume</option>
            </select>
            <input type="text" id="filterInput" class="form-control w-auto d-inline-block ms-2" placeholder="Filter by name...">
        </div>
        <table class="table table-striped animate-table" id="marketTable">
            <thead>
                <tr>
                    <th>Coin</th>
                    <th>Price (USD)</th>
                    <th>24h Change</th>
                    <th>24h Volume</th>
                    <th>Sentiment</th>
                </tr>
            </thead>
            <tbody id="marketTableBody">
                {% for coin_id, data in market_data.items %}
                <tr class="animate-row" style="--row-index: {{ forloop.counter0 }};">
                    <td><a href="{% url 'live_charts' %}?coin={{ coin_id }}" class="coin-link">{{ coin_id|capitalize_value }}</a></td>
                    <td class="price-slide" data-coin="{{ coin_id }}">${{ data.usd|format_currency }}</td>
                    <td class="{% if data.usd_24h_change|floatformat:2|add:0 >= 0 %}positive{% else %}negative{% endif %}">
                        {{ data.usd_24h_change|floatformat:2 }}%
                    </td>
                    <td>${{ data.volume_24h|format_currency }}</td>
                    <td class="sentiment-cell" data-coin="{{ coin_id }}">{{ data.sentiment|default:"Neutral" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="alert alert-warning glow-effect" role="alert">
            Unable to fetch live market data. Please try again later.
        </div>
    {% endif %}
</div>

<!-- JavaScript for Pie Chart, Sorting, Filtering, and Live Updates -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Enable Tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Pie Chart
        {% if is_data_live %}
            const ctx = document.getElementById('pricePieChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: [{% for coin_id, data in market_data.items %}'{{ coin_id|capitalize_value }}',{% endfor %}],
                    datasets: [{
                        data: [{% for coin_id, data in market_data.items %}{{ data.usd }},{% endfor %}],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: $${context.parsed.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    animation: { animateScale: true, animateRotate: true }
                }
            });
        {% endif %}

        // Sorting and Filtering
        const sortSelect = document.getElementById('sortSelect');
        const filterInput = document.getElementById('filterInput');
        const tableBody = document.getElementById('marketTableBody');

        function updateTable(data) {
            const sortKey = sortSelect.value;
            const filterText = filterInput.value.toLowerCase();
            let entries = Object.entries(data.market_data);

            // Filter
            if (filterText) {
                entries = entries.filter(([coin, _]) => coin.toLowerCase().includes(filterText));
            }

            // Sort
            entries.sort((a, b) => {
                const [coinA, dataA] = a;
                const [coinB, dataB] = b;
                if (sortKey === 'name') return coinA.localeCompare(coinB);
                if (sortKey === 'price') return dataB.usd - dataA.usd;
                if (sortKey === 'change') return dataB.usd_24h_change - dataA.usd_24h_change;
                if (sortKey === 'volume') return dataB.volume_24h - dataA.volume_24h;
                return 0;
            });

            tableBody.innerHTML = '';
            entries.forEach(([coin, info], index) => {
                const row = document.createElement('tr');
                row.className = 'animate-row';
                row.style.setProperty('--row-index', index);
                row.innerHTML = `
                    <td><a href="{% url 'live_charts' %}?coin=${coin}" class="coin-link">${coin.charAt(0).toUpperCase() + coin.slice(1)}</a></td>
                    <td class="price-slide" data-coin="${coin}">$${info.usd.toFixed(2)}</td>
                    <td class="${info.usd_24h_change >= 0 ? 'positive' : 'negative'}">${info.usd_24h_change.toFixed(2)}%</td>
                    <td>$${info.volume_24h.toFixed(2)}</td>
                    <td class="sentiment-cell" data-coin="${coin}">${info.sentiment || 'Neutral'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Live Price and Sentiment Updates
        function updateMarketTable() {
            fetch('{% url 'market_data_api' %}')
                .then(response => response.json())
                .then(data => {
                    updateTable(data);
                    // Trigger price animations
                    tableBody.querySelectorAll('.price-slide').forEach((cell, index) => {
                        cell.style.animation = 'none';
                        cell.offsetHeight;
                        cell.style.animation = 'slideInRight 0.5s ease-out forwards';
                        cell.style.animationDelay = `${index * 0.1}s`;
                    });
                })
                .catch(error => console.error('Error updating market table:', error));
        }

        sortSelect.addEventListener('change', updateMarketTable);
        filterInput.addEventListener('input', updateMarketTable);
        setInterval(updateMarketTable, 30000);
        updateMarketTable();
    });
</script>

<style>
    .coin-link {
        color: var(--text-color);
        text-decoration: none;
    }
    .coin-link:hover {
        color: #00d4ff;
    }
</style>
{% endblock %}